---
config:
  layout: elk
  theme: base
  themeVariables:
    background: '#ffffff'
    primaryColor: '#ffffff'
---
flowchart TB
    %% User Layer
    subgraph UserLayer ["👥 User Layer"]
        User["👤 User"]
        Browser["🌐 Web Browser"]
    end

    %% Frontend Layer
    subgraph Frontend ["💻 Frontend (React)"]
        %% Page Layer
        MyPage["👤 My Page"]
        TarotPrinciple["📖 Tarot Principle"]
        HomePage["🏠 Home Page"]
        ETC["📖 ETC"]
        
        %% Component Layer  
        TarotModal["🔮 Tarot Modal"]
        AnswerModal["📖 Answer Modal"]
        PurchaseModal["🛒 Purchase Modal"]
        ThreeScene["🎮 3D Scene"]
        GoogleAd["📢 Google Ad Component"]
        
        %% Localization
        i18n["🌐 i18n (ko/en/ja)"]
        
        %% State Management
        ReduxToolkit["⚡ Redux Toolkit Store"]
        TokenStorage["💾 Token Storage (Cookie/LocalStorage/Preference)"]
    end

    %% Authentication Layer
    subgraph AuthLayer ["🔐 Authentication Layer"]
        AuthFlow["🔐 Google OAuth + JWT"]
    end

    %% API Layer
    subgraph APILayer ["🌐 API Layer"]
        APIGateway["📡 Express.js Router + Google OAuth + JWT"]
    end

    %% Backend Service Layer
    subgraph Backend ["🖥️ Backend Services (Node.js)"]
        %% Router Layer
        AuthRouter["🔐 Auth Router"]
        TarotRouter["🔮 Tarot Router"]
        UserRouter["👤 User Router"]
        ChargeRouter["💳 Charge Router"]
        
        %% Controller Layer
        TarotController["🔮 Tarot Controller"]
        UserController["👤 User Controller"]
        ChargeController["💳 Charge Controller"]
        
        %% Service Layer
        TarotService["🔮 Tarot Service"]
        UserService["👤 User Service"]
        ChargeService["💳 Charge Service"]
        
        %% Repository Layer
        TarotRepository["🔮 Tarot Repository"]
        UserRepository["👤 User Repository"]
        ChargeRepository["💳 Charge Repository"]
        
        %% Model Layer
        TarotModel["🔮 Tarot Model"]
        UserModel["👤 User Model"]
        ChargeModel["💳 Charge Model"]
    end

    %% AI Service Layer
    subgraph AILayer ["🤖 AI Service Layer"]
        AIInterpreter["🧠 AI Interpreter"]
        AI["💡 AI"]
        SystemPrompt["⚙️ System Prompt"]
        UserPrompt["👤 User Prompt"]
        ResponseFormat["📋 Response Format"]
    end

    %% Data Layer
    subgraph DataLayer ["💾 Data Layer"]
        MongoDB[("🍃 MongoDB")]
        Redis[("⚡ Redis Cache")]
        UserCollection["👤 Users Collection"]
        TarotCollection["🔮 Tarots Collection"]
        ChargeCollection["💳 Charges Collection"]
    end

    %% External Services
    subgraph ExternalLayer ["🌍 External Services"]
        GoogleAuth["🔐 Google OAuth"]
        TossPayments["💳 Toss Payments"]
        InAppPurchase["📱 In-App Purchase"]
        GooglePlayConsole["🎮 Google Play Console"]
        AdMob["📢 Google AdMob"]
        AdSense["📰 Google AdSense"]
    end

    %% Connections
    User --> Browser
    Browser --> HomePage
    Browser --> TarotPrinciple
    Browser --> ETC
    
    %% MyPage 인증 플로우
    Browser --> AuthFlow
    AuthFlow --> MyPage
    
    HomePage --> ThreeScene
    HomePage --> i18n
    TarotPrinciple --> i18n
    MyPage --> i18n
    ETC --> i18n
    
    %% 3D Scene -> Tarot Modal 인증 플로우
    ThreeScene --> AuthFlow
    AuthFlow --> TarotModal
    
    TarotModal --> AnswerModal
    TarotModal --> PurchaseModal
    TarotModal --> GoogleAd
    MyPage --> AnswerModal
    MyPage --> PurchaseModal
    
    GoogleAd --> AdMob
    GoogleAd --> AdSense
    
    TarotModal --> TokenStorage
    TokenStorage --> APIGateway
    PurchaseModal --> APIGateway
    
    %% 통합된 인증 플로우
    AuthFlow --> AuthRouter
    AuthRouter --> GoogleAuth
    GoogleAuth --> UserRepository
    AuthFlow --> APIGateway
    
    APIGateway --> AuthRouter
    APIGateway --> TarotRouter
    APIGateway --> UserRouter
    APIGateway --> ChargeRouter
    
    TarotRouter --> TarotController
    UserRouter --> UserController
    ChargeRouter --> ChargeController
    
    TarotController --> TarotService
    TarotController --> UserService
    UserController --> UserService
    ChargeController --> ChargeService
    ChargeController --> UserService
    
    TarotService --> UserPrompt
    TarotService --> TarotRepository
    TarotService --> Redis
    UserService --> UserRepository
    UserService --> Redis
    ChargeService --> ChargeRepository
    ChargeService --> TossPayments
    ChargeService --> InAppPurchase
    
    SystemPrompt --> AIInterpreter
    UserPrompt --> AIInterpreter
    ResponseFormat --> AIInterpreter
    AIInterpreter --> AI
    
    TarotRepository --> TarotModel
    UserRepository --> UserModel
    ChargeRepository --> ChargeModel
    
    TarotModel --> TarotCollection
    UserModel --> UserCollection
    ChargeModel --> ChargeCollection
    
    TarotCollection --> MongoDB
    UserCollection --> MongoDB
    ChargeCollection --> MongoDB
    
    InAppPurchase --> GooglePlayConsole

    %% Styling Classes
    classDef userClass fill:#e1f5fe,stroke:#01579b,stroke-width:3px,color:#000
    classDef frontendClass fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000
    classDef authClass fill:#ffebee,stroke:#c62828,stroke-width:3px,color:#000
    classDef backendClass fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px,color:#000
    classDef aiClass fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000
    classDef dataClass fill:#fce4ec,stroke:#880e4f,stroke-width:2px,color:#000
    classDef externalClass fill:#fff8e1,stroke:#f57f17,stroke-width:2px,color:#000
    classDef layerClass fill:#f5f5f5,stroke:#666,stroke-width:2px,color:#000

    %% Apply Classes
    class User,Browser userClass
    class MyPage,HomePage,TarotPrinciple,ETC,TarotModal,AnswerModal,PurchaseModal,ThreeScene,GoogleAd,i18n,ReduxToolkit,TokenStorage frontendClass
    class AuthFlow authClass
    class APIGateway,AuthRouter,TarotRouter,UserRouter,ChargeRouter,TarotController,UserController,ChargeController,TarotService,UserService,ChargeService,TarotRepository,UserRepository,ChargeRepository,TarotModel,UserModel,ChargeModel backendClass
    class AIInterpreter,AI,SystemPrompt,UserPrompt,ResponseFormat aiClass
    class MongoDB,Redis,UserCollection,TarotCollection,ChargeCollection dataClass
    class GoogleAuth,TossPayments,InAppPurchase,GooglePlayConsole,AdMob,AdSense externalClass
    class UserLayer,Frontend,AuthLayer,APILayer,Backend,AILayer,DataLayer,ExternalLayer layerClass
