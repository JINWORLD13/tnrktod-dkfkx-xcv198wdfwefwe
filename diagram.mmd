---
config:
  layout: elk
  theme: base
  themeVariables:
    background: '#ffffff'
    primaryColor: '#ffffff'
---
flowchart TB
    %% User Layer
    subgraph UserLayer ["ðŸ‘¥ User Layer"]
        User["ðŸ‘¤ User"]
        Browser["ðŸŒ Web Browser"]
    end

    %% Frontend Layer
    subgraph Frontend ["ðŸ’» Frontend (React)"]
        %% Page Layer
        MyPage["ðŸ‘¤ My Page"]
        TarotPrinciple["ðŸ“– Tarot Principle"]
        HomePage["ðŸ  Home Page"]
        ETC["ðŸ“– ETC"]
        
        %% Component Layer  
        TarotModal["ðŸ”® Tarot Modal"]
        AnswerModal["ðŸ“– Answer Modal"]
        PurchaseModal["ðŸ›’ Purchase Modal"]
        ThreeScene["ðŸŽ® 3D Scene"]
        GoogleAd["ðŸ“¢ Google Ad Component"]
        
        %% Localization
        i18n["ðŸŒ i18n (ko/en/ja)"]
        
        %% State Management
        ReduxToolkit["âš¡ Redux Toolkit Store"]
        TokenStorage["ðŸ’¾ Token Storage (Cookie/LocalStorage/Preference)"]
    end

    %% Authentication Layer
    subgraph AuthLayer ["ðŸ” Authentication Layer"]
        AuthFlow["ðŸ” Google OAuth + JWT"]
    end

    %% API Layer
    subgraph APILayer ["ðŸŒ API Layer"]
        APIGateway["ðŸ“¡ Express.js Router + Google OAuth + JWT"]
    end

    %% Backend Service Layer
    subgraph Backend ["ðŸ–¥ï¸ Backend Services (Node.js)"]
        %% Router Layer
        AuthRouter["ðŸ” Auth Router"]
        TarotRouter["ðŸ”® Tarot Router"]
        UserRouter["ðŸ‘¤ User Router"]
        ChargeRouter["ðŸ’³ Charge Router"]
        
        %% Controller Layer
        TarotController["ðŸ”® Tarot Controller"]
        UserController["ðŸ‘¤ User Controller"]
        ChargeController["ðŸ’³ Charge Controller"]
        
        %% Service Layer
        TarotService["ðŸ”® Tarot Service"]
        UserService["ðŸ‘¤ User Service"]
        ChargeService["ðŸ’³ Charge Service"]
        
        %% Repository Layer
        TarotRepository["ðŸ”® Tarot Repository"]
        UserRepository["ðŸ‘¤ User Repository"]
        ChargeRepository["ðŸ’³ Charge Repository"]
        
        %% Model Layer
        TarotModel["ðŸ”® Tarot Model"]
        UserModel["ðŸ‘¤ User Model"]
        ChargeModel["ðŸ’³ Charge Model"]
    end

    %% AI Service Layer
    subgraph AILayer ["ðŸ¤– AI Service Layer"]
        AIInterpreter["ðŸ§  AI Interpreter"]
        AI["ðŸ’¡ AI"]
        SystemPrompt["âš™ï¸ System Prompt"]
        UserPrompt["ðŸ‘¤ User Prompt"]
        ResponseFormat["ðŸ“‹ Response Format"]
    end

    %% Data Layer
    subgraph DataLayer ["ðŸ’¾ Data Layer"]
        MongoDB[("ðŸƒ MongoDB")]
        Redis[("âš¡ Redis Cache")]
        UserCollection["ðŸ‘¤ Users Collection"]
        TarotCollection["ðŸ”® Tarots Collection"]
        ChargeCollection["ðŸ’³ Charges Collection"]
    end

    %% External Services
    subgraph ExternalLayer ["ðŸŒ External Services"]
        GoogleAuth["ðŸ” Google OAuth"]
        TossPayments["ðŸ’³ Toss Payments"]
        InAppPurchase["ðŸ“± In-App Purchase"]
        GooglePlayConsole["ðŸŽ® Google Play Console"]
        AdMob["ðŸ“¢ Google AdMob"]
        AdSense["ðŸ“° Google AdSense"]
    end

    %% Connections
    User --> Browser
    Browser --> HomePage
    Browser --> TarotPrinciple
    Browser --> ETC
    
    %% MyPage ì¸ì¦ í”Œë¡œìš°
    Browser --> AuthFlow
    AuthFlow --> MyPage
    
    HomePage --> ThreeScene
    HomePage --> i18n
    TarotPrinciple --> i18n
    MyPage --> i18n
    ETC --> i18n
    
    %% 3D Scene -> Tarot Modal ì¸ì¦ í”Œë¡œìš°
    ThreeScene --> AuthFlow
    AuthFlow --> TarotModal
    
    TarotModal --> AnswerModal
    TarotModal --> PurchaseModal
    TarotModal --> GoogleAd
    MyPage --> AnswerModal
    MyPage --> PurchaseModal
    
    GoogleAd --> AdMob
    GoogleAd --> AdSense
    
    TarotModal --> TokenStorage
    TokenStorage --> APIGateway
    PurchaseModal --> APIGateway
    
    %% í†µí•©ëœ ì¸ì¦ í”Œë¡œìš°
    AuthFlow --> AuthRouter
    AuthRouter --> GoogleAuth
    GoogleAuth --> UserRepository
    AuthFlow --> APIGateway
    
    APIGateway --> AuthRouter
    APIGateway --> TarotRouter
    APIGateway --> UserRouter
    APIGateway --> ChargeRouter
    
    TarotRouter --> TarotController
    UserRouter --> UserController
    ChargeRouter --> ChargeController
    
    TarotController --> TarotService
    TarotController --> UserService
    UserController --> UserService
    ChargeController --> ChargeService
    ChargeController --> UserService
    
    TarotService --> UserPrompt
    TarotService --> TarotRepository
    TarotService --> Redis
    UserService --> UserRepository
    UserService --> Redis
    ChargeService --> ChargeRepository
    ChargeService --> TossPayments
    ChargeService --> InAppPurchase
    
    SystemPrompt --> AIInterpreter
    UserPrompt --> AIInterpreter
    ResponseFormat --> AIInterpreter
    AIInterpreter --> AI
    
    TarotRepository --> TarotModel
    UserRepository --> UserModel
    ChargeRepository --> ChargeModel
    
    TarotModel --> TarotCollection
    UserModel --> UserCollection
    ChargeModel --> ChargeCollection
    
    TarotCollection --> MongoDB
    UserCollection --> MongoDB
    ChargeCollection --> MongoDB
    
    InAppPurchase --> GooglePlayConsole

    %% Styling Classes
    classDef userClass fill:#e1f5fe,stroke:#01579b,stroke-width:3px,color:#000
    classDef frontendClass fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000
    classDef authClass fill:#ffebee,stroke:#c62828,stroke-width:3px,color:#000
    classDef backendClass fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px,color:#000
    classDef aiClass fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000
    classDef dataClass fill:#fce4ec,stroke:#880e4f,stroke-width:2px,color:#000
    classDef externalClass fill:#fff8e1,stroke:#f57f17,stroke-width:2px,color:#000
    classDef layerClass fill:#f5f5f5,stroke:#666,stroke-width:2px,color:#000

    %% Apply Classes
    class User,Browser userClass
    class MyPage,HomePage,TarotPrinciple,ETC,TarotModal,AnswerModal,PurchaseModal,ThreeScene,GoogleAd,i18n,ReduxToolkit,TokenStorage frontendClass
    class AuthFlow authClass
    class APIGateway,AuthRouter,TarotRouter,UserRouter,ChargeRouter,TarotController,UserController,ChargeController,TarotService,UserService,ChargeService,TarotRepository,UserRepository,ChargeRepository,TarotModel,UserModel,ChargeModel backendClass
    class AIInterpreter,AI,SystemPrompt,UserPrompt,ResponseFormat aiClass
    class MongoDB,Redis,UserCollection,TarotCollection,ChargeCollection dataClass
    class GoogleAuth,TossPayments,InAppPurchase,GooglePlayConsole,AdMob,AdSense externalClass
    class UserLayer,Frontend,AuthLayer,APILayer,Backend,AILayer,DataLayer,ExternalLayer layerClass
